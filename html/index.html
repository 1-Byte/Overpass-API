<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
  <title>OSM Server Side Script</title>
</head>
<body>

<h1>OSM Server Side Script</h1>

<!--
offene Probleme:
- gzip-Komprimierung
- area-query
- recurse: area-node
- Durchsetzung der Constraints
//-->

<p>
<a href="#chapter.introduction">Introduction</a><br/>
<a href="#chapter.use_cases">Use Cases</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.reverse_gazetteer">To which country belongs this location?</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.download_area">Download an entire city</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.debug_area">Why doesn't my city appear?</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.rule_example">Declare a new type of area</a><br/>
<a href="#chapter.interface_calls">Interface Calls</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.interpreter">/api/interpreter</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.get_rule">/api/get_rule</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.add_rule">/api/add_rule</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.update_rule">/api/update_rule</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.status">/api/status</a><br/>
<a href="#chapter.statements">Statements</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.area_query">area-query</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.conflict">conflict</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.coord_query">coord-query</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.detect_odd_nodes">detect-odd-nodes</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.foreach">foreach</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.id_query">id-query</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.item">item</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.make_area">make-area</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.osm_script">osm-script</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.print">print</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.query">query</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.recurse">recurse</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.report">report</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.union">union</a><br/>
<a href="#chapter.concepts">Concepts</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.data_structures">Data structures</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.control_flow">Control Flow</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.variables">Variables</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.other_sets">Other Sets in Scripts</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.flow_forecast">Flow Forecast</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.quotas">Limits and Quotas</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.database_layout">Database Layout</a><br/>
<a href="#chapter.input_formats">Input Formats</a><br/>
<a href="#chapter.output_formats">Output Formats</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.payload">Payload</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.status_remarks">Status Remarks</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.hypertext_reports">Hypertext Reports</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#section.static_feedback">Static Error Feedback</a><br/>
</p>

<div>
<a id="chapter.introduction"/>
<h2>Introduction</h2>
</div>

<p>
</p>

<div>
<a id="chapter.use_cases"/>
<h2>Use Cases</h2>
</div>

<p>
<a href="#section.reverse_gazetteer">To which country belongs this location?</a><br/>
<a href="#section.download_area">Download an entire city</a><br/>
<a href="#section.debug_area">Why doesn't my city appear?</a><br/>
<a href="#section.rule_example">Declare a new type of area</a><br/>
</p>

<p>The following examples are some sample use cases to give you an idea
what you can do with the system. Of course, there are many more useful
use cases, and you are kindly invited to add other use cases.</p>

<div>
<a id="section.reverse_gazetteer"/>
<h3>To which country belongs this location?</h3>
</div>

<p>
To determine in which areas a location specified by latitude and longitude lies, just change the latitude and longitude in the following script to appriate values:<br/>
<form action="api/interpreter" method="post" accept-charset="UTF-8">
  <textarea name="data" rows="3" cols="80">&lt;coord-query lat="51.25" lon="7.15"/&gt;
&lt;print mode="body"/&gt;
</textarea>
  <input type="submit" value="Explore"/>
</form><br/>
Of course, you can send this script also via any other <a href="#chapter.input_formats">way of submitting input</a> to <a href="#section.interpreter">/api/interpreter</a>. You will recieve a gzip-compressed XML-file in an <a href="#chapter.output_formats">adapted OSM format</a> that <a href="#section.payload">contains the areas</a> the location lies in.
</p>

<p>
The first command, <a href="#section.coord_query">&lt;coord-query lat="51.25" lon="7.15"/&gt;</a>, searches the database for every area that covers the location defined by the latitude and longitude values. Then it stores the result into the <a href="#section.variables">default set</a>. Afterwards, the second command <a href="#section.print">&lt;print mode="body"/&gt;</a> prints the content of the default set. The mode="body" indicates there that it shall print the <a href="#section.data_structures">id and members</a> of the area as well as is <a href="#section.data_structures">tags</a>.<br/>
</p>

<div>
<a id="section.download_area"/>
<h3>Download an entire city</h3>
</div>

<p>
This is in general a two-step process. For the first step, determine the id of the area to download, e.g. from the result of a <a href="#section.coord_query">coord-query</a> like in the <a href="#section.reverse_gazetteer">above example</a>. Another way to determine the id is to take advantage of <a href="#section.data_structures">the way the areas obtain their id</a>:
<ul>
<li>An area based on a node has the same id as the node.</li>
<li>An area based on a way has the the id of the way plus 2,400,000,000.</li>
<li>An area based on a relation has the id of the relation plus 3,600,000,000.</li>
</ul>
For example, the area representing the German city "Wuppertal" has id 3,600,062,478 because its pivot element is the relation 62,478 describing the borders of Wuppertal. In particular this means that area ids are as stable as the ids in the OSM database.
</p>

<p>
The second step is the script to actually download the area: This script will take 15-30 seconds before it gives a response depending on server load.<br/>
<form action="api/interpreter" method="post" accept-charset="UTF-8">
  <textarea name="data" rows="8" cols="80">&lt;union&gt;
  &lt;area-query ref="3600062478"/&gt;
  &lt;recurse type="node-relation" into="rels"/&gt;
  &lt;recurse type="node-way"/&gt;
  &lt;recurse type="way-relation"/&gt;
&lt;/union&gt;
&lt;print mode="body"/&gt;
</textarea>
  <input type="submit" value="Download"/>
</form><br/>
Again, you can send this script also via any other <a href="#chapter.input_formats">way of submitting input</a> to <a href="#section.interpreter">/api/interpreter</a>. You will recieve a gzip-compressed XML-file in an <a href="#chapter.output_formats">adapted OSM format</a> that <a href="#section.payload">contains</a> all nodes that lie in this area (including all the nodes on the boundary), all ways that are referred from such a node and all relations that are referred by such a way or such a node.
</p>

<p>
If you prefer to receive additionally all nodes any way refers to, you can change the script to: This script also will take some time before it gives a response depending on server load.<br/>
<form action="api/interpreter" method="post" accept-charset="UTF-8">
  <textarea name="data" rows="16" cols="80">&lt;osm-script timeout="180"&gt;

&lt;union&gt;
  &lt;area-query ref="3600062478"/&gt;
  &lt;recurse type="node-relation" into="rels"/&gt;
  &lt;recurse type="node-way"/&gt;
  &lt;recurse type="way-relation"/&gt;
&lt;/union&gt;
&lt;union&gt;
  &lt;item/&gt;
  &lt;recurse type="way-node"/&gt;
&lt;/union&gt;
&lt;print mode="body"/&gt;

&lt;/osm-script&gt;
</textarea>
  <input type="submit" value="Download"/>
</form><br/>
</p>

<p>
We briefly explain both scripts and start with the first one: The statement <a href="#section.union">&lt;union&gt;</a> <a href="#section.other_sets">collects</a> the output of the enclosed statements in line 2 to 6. The block starts with the query <a href="#section.area_query">&lt;area-query ref="3600062478"/&gt;</a>. This statement returns all the nodes that lie inside or on the border of the area with id given by the parameter ref and stores them in into the <a href="#section.variables">default set</a>. In the third line, <a href="#section.recurse">&lt;recurse type="node-relation" into="rels"/&gt;</a> returns all relations that have as member a node from the input, in this case the <a href="#section.variables">default set</a>, into the set "rels". As this happens within an <a href="#section.union">union</a>-block, the new content of the set "rels" is added to the result of the <a href="#section.union">union</a>-block as a whole. In the next line, <a href="#section.recurse">&lt;recurse type="node-way"/&gt;</a> puts into the <a href="#section.variables">default set</a> the ways that refer to at least one node from the <a href="#section.variables">default set</a>. In particular, the default set now contains only ways, the <a href="#section.union">union</a>-block has collected so far all nodes and ways and some relations. In the last line of the block, <a href="#section.recurse">&lt;recurse type="way-relation"/&gt;</a> puts into the <a href="#section.variables">default set</a> all relations that refer to at least one way from the <a href="#section.variables">default set</a> beforehand. The <a href="#section.union">union</a>-block again collects these relations. Now the <a href="#section.union">union</a>-block contains altogether the nodes within the area and the ways and relations that refer to such a node or way. As there is no output parameter given, this set is stored into the <a href="#section.variables">default set</a>. The statement after the block, <a href="#section.print">&lt;print mode="body"/&gt;</a> then prints the entire content of the <a href="#section.variables">default set</a> with all its details as specified by the value "body" of the parameter "mode".
</p>

<p>
The second script differs from the first one in two aspects: It exhibits the root element <a href="#section.osm_script">&lt;osm-script timeout="180"&gt;</a> to change a global setting from its default: Without explicit timeout, the server <a href="#section.flow_forecast">forecasts</a> the runtime of the script and refuses its execution if it could take too much ressources. With a manual <a href="#section.quotas">timeout</a>, the script will be accepted regardless of its predicted runtime, but it will be aborted if it exceeeds its timeout. The second difference is the second <a href="#section.union">union</a>-block: The first statement <a href="#section.item">&lt;item/&gt;</a> just makes the current <a href="#section.variables">default set</a> part of the result of the <a href="#section.union">union</a>-block. The second statement <a href="#section.recurse">&lt;recurse type="way-node"/&gt;</a> replaces the <a href="#section.variables">default set</a> with the set of all nodes that are referred by the ways in the <a href="#section.variables">default set</a> beforehand. This result is collected by the <a href="#section.union">union</a>-block. Thus, the result now conatins all nodes that are referred by a way appearing in the set.
</p>

<div>
<a id="section.debug_area"/>
<h3>Why doesn't my city appear?</h3>
</div>

<div>
<a id="section.rule_example"/>
<h3>Declare a new type of area</h3>
</div>

<div>
<a id="chapter.interface_calls"/>
<h2>Interface Calls</h2>
</div>

<p>
<a href="#section.interpreter">/api/interpreter</a><br/>
<a href="#section.get_rule">/api/get_rule</a><br/>
<a href="#section.add_rule">/api/add_rule</a><br/>
<a href="#section.update_rule">/api/update_rule</a><br/>
<a href="#section.status">/api/status</a><br/>
</p>

<div>
<a id="section.interpreter"/>
<h3>/api/interpreter</h3>
</div>

<div>
<a id="section.get_rule"/>
<h3>/api/get_rule</h3>
</div>

<div>
<a id="section.add_rule"/>
<h3>/api/add_rule</h3>
</div>

<div>
<a id="section.update_rule"/>
<h3>/api/update_rule</h3>
</div>

<div>
<a id="section.status"/>
<h3>/api/status</h3>
</div>

<div>
<a id="chapter.statements"/>
<h2>Statements</h2>
</div>

<p>
<a href="#section.area_query">area-query</a><br/>
<a href="#section.conflict">conflict</a><br/>
<a href="#section.coord_query">coord-query</a><br/>
<a href="#section.detect_odd_nodes">detect-odd-nodes</a><br/>
<a href="#section.foreach">foreach</a><br/>
<a href="#section.id_query">id-query</a><br/>
<a href="#section.item">item</a><br/>
<a href="#section.make_area">make-area</a><br/>
<a href="#section.osm_script">osm-script</a><br/>
<a href="#section.print">print</a><br/>
<a href="#section.query">query</a><br/>
<a href="#section.recurse">recurse</a><br/>
<a href="#section.report">report</a><br/>
<a href="#section.union">union</a><br/>
</p>

<div>
<a id="section.area_query"/>
<h3>area-query</h3>
</div>

<div>
<a id="section.conflict"/>
<h3>conflict</h3>
</div>

<div>
<a id="section.coord_query"/>
<h3>coord-query</h3>
</div>

<div>
<a id="section.detect_odd_nodes"/>
<h3>detect-odd-nodes</h3>
</div>

<div>
<a id="section.foreach"/>
<h3>foreach</h3>
</div>

<div>
<a id="section.id_query"/>
<h3>id-query</h3>
</div>

<div>
<a id="section.item"/>
<h3>item</h3>
</div>

<div>
<a id="section.make_area"/>
<h3>make-area</h3>
</div>

<div>
<a id="section.osm_script"/>
<h3>osm-script</h3>
</div>

<div>
<a id="section.print"/>
<h3>print</h3>
</div>

<div>
<a id="section.query"/>
<h3>query</h3>
</div>

<div>
<a id="section.recurse"/>
<h3>recurse</h3>
</div>

<div>
<a id="section.report"/>
<h3>report</h3>
</div>

<div>
<a id="section.union"/>
<h3>union</h3>
</div>


<div>
<a id="chapter.concepts"/>
<h2>Concepts</h2>
</div>

<p>
<a href="#section.data_structures">Data structures</a><br/>
<a href="#section.control_flow">Control Flow</a><br/>
<a href="#section.variables">Variables</a><br/>
<a href="#section.other_sets">Other Sets in Scripts</a><br/>
<a href="#section.flow_forecast">Flow Forecast</a><br/>
<a href="#section.quotas">Limits and Quotas</a><br/>
<a href="#section.database_layout">Database Layout</a><br/>
</p>

<div>
<a id="section.data_structures"/>
<h3>Data structures</h3>
</div>

<div>
<a id="section.control_flow"/>
<h3>Control Flow</h3>
</div>

<div>
<a id="section.variables"/>
<h3>Variables</h3>
</div>

<div>
<a id="section.other_sets"/>
<h3>Other Sets in Scripts</h3>
</div>

<div>
<a id="section.flow_forecast"/>
<h3>Flow Forecast</h3>
</div>

<div>
<a id="section.quotas"/>
<h3>Limits and Quotas</h3>
</div>

<div>
<a id="section.database_layout"/>
<h3>Database Layout</h3>
</div>

<div>
<a id="chapter.input_formats"/>
<h2>Input Formats</h2>
</div>

<p>
</p>

<div>
<a id="chapter.output_formats"/>
<h2>Output Formats</h2>
</div>

<p>
<a href="#section.payload">Payload</a><br/>
<a href="#section.status_remarks">Status Remarks</a><br/>
<a href="#section.hypertext_reports">Hypertext Reports</a><br/>
<a href="#section.static_feedback">Static Error Feedback</a><br/>
</p>

<div>
<a id="section.payload"/>
<h3>Payload</h3>
</div>

<div>
<a id="section.status_remarks"/>
<h3>Status Remarks</h3>
</div>

<div>
<a id="section.hypertext_reports"/>
<h3>Hypertext Reports</h3>
</div>

<div>
<a id="section.static_feedback"/>
<h3>Static Error Feedback</h3>
</div>

</body>
</html>
