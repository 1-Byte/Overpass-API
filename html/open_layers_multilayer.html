<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
  <title>OSM3S on Mapnik via Open Layers</title>
  <script src="http://openlayers.org/api/OpenLayers.js"></script>
  <script src="http://openstreetmap.org/openlayers/OpenStreetMap.js"></script>
  <script type="text/javascript">
      var lat = 50.727;
      var lon = 7.092;
      var zoom = 15;
/*      var data_url = "api/interpreter?data=node[amenity=school](bbox);out;(way[amenity=school](bbox);node(w););out;";*/
      var zoom_data_limit = 13;
      var map;

      var zoom_valid = true;
      var load_counter = 0;

      function setStatusText(text)
      {
          var div = document.getElementById("statusline").firstChild;
          div.deleteData(0, div.nodeValue.length);
          div.appendData(text);
      }

      function make_features_added_closure() {
          return function(evt) {
              if (zoom_valid)
              {
                  --load_counter;
                  if (load_counter <= 0)
                      setStatusText("");
              }
          };
      }

      ZoomLimitedBBOXStrategy = OpenLayers.Class(OpenLayers.Strategy.BBOX, {

          ratio: 1.1,

          update: function(options) {
              var mapBounds = this.getMapBounds();
              if (this.layer && this.layer.map && this.layer.map.getZoom() < zoom_data_limit) {
                  setStatusText("Please zoom in to view data.");
                  zoom_valid = false;

                  this.bounds = null;
              }
              else if (mapBounds !== null && ((options && options.force) ||
                                         this.invalidBounds(mapBounds))) {
                  ++load_counter;
                  setStatusText("Loading data ...");
                  zoom_valid = true;

                  this.calculateBounds(mapBounds);
                  this.resolution = this.layer.map.getResolution();
                  this.triggerRead(options);
              }
          },

          CLASS_NAME: "ZoomLimitedBBOXStrategy"
      });

      function make_layer(data_url, color) {

          var styleMap = new OpenLayers.StyleMap({
              strokeColor: color,
              strokeOpacity: 0.5,
              strokeWidth: 6,
              pointRadius: 10,
              fillColor: color,
              fillOpacity: 0.25
          });
          var layer = new OpenLayers.Layer.Vector(color, {
              strategies: [new ZoomLimitedBBOXStrategy()],
              protocol: new OpenLayers.Protocol.HTTP({
                  url: data_url,
                  format: new OpenLayers.Format.OSM()
              }),
              styleMap: styleMap,
              projection: new OpenLayers.Projection("EPSG:4326")
          });

          layer.events.register("featuresadded", layer, make_features_added_closure());

          return layer;
      }

      function init(){
          map = new OpenLayers.Map ("map", {
          controls:[
              new OpenLayers.Control.Navigation(),
              new OpenLayers.Control.PanZoomBar(),
              new OpenLayers.Control.LayerSwitcher(),
              new OpenLayers.Control.Attribution()],
              maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
              maxResolution: 156543.0399,
              numZoomLevels: 19,
              units: 'm',
              projection: new OpenLayers.Projection("EPSG:900913"),
              displayProjection: new OpenLayers.Projection("EPSG:4326")
          } );

          layerMapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");
          map.addLayer(layerMapnik);
          layerCycleMap = new OpenLayers.Layer.OSM.CycleMap("CycleMap");
          map.addLayer(layerCycleMap);

          var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

          map.setCenter (lonLat, zoom);

          map.addLayers([
              make_layer("api/interpreter?data=node[amenity=kindergarten](bbox);out;(way[amenity=kindergarten](bbox);node(w););out+skel;", "green"),
              make_layer("api/interpreter?data=node[amenity=school](bbox);out;(way[amenity=school](bbox);node(w););out+skel;", "blue"),
              make_layer("api/interpreter?data=node[amenity=university](bbox);out;(way[amenity=university](bbox);node(w););out+skel;", "orange")
          ]);
      }
  </script>
</head>
<body onload="init()">
  <div id="statusline" style="font-size:24pt; font-weight:bold; font-family:sans-serif">No status set yet.</div>
  <div id="map" class="smallmap"></div>

</body>
</html>


