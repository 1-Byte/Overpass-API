<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
  <title>OSM3S Experimental Diff</title>
  <script src="http://openlayers.org/api/2.13.1/OpenLayers.js"></script>
  <script src="http://overpass-api.de/OpenStreetMap.js"></script>
  <script src="http://overpass-api.de/overpass.js"></script>
  <script type="text/javascript">
      var lat = 50.734;
      var lon = 7.100;
      var zoom = 18;
      var data_url = "http://overpass-api.de/api/interpreter_0750";
      var map;

      var layer = false;
      var layerMapnik = false;
      
      function refreshData()
      {
          if (layer)
              map.removeLayer(layer);
          clearTextualResults();

          setStatus("Loading data");

          var mindate = fullDate(new Date());
          var select_mindate = document.getElementById("select_mindate");
          if (select_mindate)
              mindate = select_mindate.value;

          //Initialise the vector layer using OpenLayers.Format.OSM
          var styleMap = new OpenLayers.StyleMap({
              strokeColor: "blue",
              strokeOpacity: 0.5,
              strokeWidth: 6,
              pointRadius: 10,
              fillColor: "blue",
              fillOpacity: 0.25
          });
          
          var lookup = {
              "old": { strokeColor: "red", fillColor: "red" },
              "new": { strokeColor: "green", fillColor: "green" }
          }
          
          styleMap.addUniqueValueRules("default", "state", lookup);
          layer = new OpenLayers.Layer.Vector("Polygon", {
              strategies: [new OpenLayers.Strategy.Fixed()],
              protocol: new OpenLayers.Protocol.HTTP({
                  //url: data_url + layerMapnik.getExtent().transform("EPSG:900913", "EPSG:4326").toBBOX(),
                  url: data_url + "?data=[adiff:\"" + mindate + "\"];(node(bbox);way(bbox);relation(bbox););out meta geom(bbox);&bbox=" + layerMapnik.getExtent().transform("EPSG:900913", "EPSG:4326").toBBOX(),
                  format: new OSMDiffFormat({
                      extent: layerMapnik.getExtent().transform("EPSG:900913", "EPSG:4326"),
                      setStatus: function(status) { setStatus(status); },
                      pushTextualResult: function(feature) { pushTextualResult(feature); }
                      })
              }),
              styleMap: styleMap,
              projection: new OpenLayers.Projection("EPSG:4326")
          });

          map.addLayers([layer]);
      }


      function fullDate(date)
      {
          var result = date.getUTCFullYear();
          result += "-";

          var month = date.getUTCMonth() + 1;
          result += (month <= 9 ? ("0" + month) : month); 

          result += "-";

          var day = date.getUTCDate();
          result += (day <= 9 ? ("0" + day) : day); 

          result += "T";

          var hour = date.getUTCHours();
          result += (hour <= 9 ? ("0" + hour) : hour); 

          result += ":";

          var minute = date.getUTCMinutes();
          result += (minute <= 9 ? ("0" + minute) : minute); 

          result += ":";

          var second = date.getUTCSeconds();
          result += (second <= 9 ? ("0" + second) : second); 

          result += "Z";

          return result;
      }

      function init()
      {
          map = new OpenLayers.Map ("map", {
          controls:[
              new OpenLayers.Control.Navigation(),
              new OpenLayers.Control.PanZoomBar(),
              new OpenLayers.Control.LayerSwitcher(),
              new OpenLayers.Control.Attribution()],
              maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
              maxResolution: 156543.0399,
              numZoomLevels: 19,
              units: 'm',
              projection: new OpenLayers.Projection("EPSG:900913"),
              displayProjection: new OpenLayers.Projection("EPSG:4326")
          } );

          layerMapnik = new OpenLayers.Layer.OSM.Mapnik("Mapnik");
          map.addLayer(layerMapnik);

          var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

          map.setCenter (lonLat, zoom);

          var yesterday = new Date(new Date().getTime() - 86400*1000);
          var select_mindate = document.getElementById("select_mindate");
          if (select_mindate)
              select_mindate.value = fullDate(yesterday);

          refreshData();
      }

      function setStatus(status)
      {
          var status_line = document.getElementById("status_line");
          if (status_line)
              status_line.innerHTML = status;
      }
      
      function clearTextualResults()
      {
          var textual_results = document.getElementById("textual_results");
          if (textual_results)
              textual_results.innerHTML = "";
      }

      function pushTextualResult(feature)
      {
          var result = "<br/><br/>";
          
          if (feature.data && feature.data.state)
              result += feature.data.state + " ";
              
          if (feature.type)
              result += feature.type + " ";
      
          if (feature.osm_id)
              result += feature.osm_id + " ";
              
          if (feature.tags)
          {
              for (tag in feature.tags)
                  result += "<br/>" + tag + "=" + feature.tags[tag];
          }
              
          var textual_results = document.getElementById("textual_results");
          if (textual_results)
              textual_results.innerHTML += result;
      }

  </script>
</head>
<body onload="init()">
  <div id="control_bar" class="control_bar" style="position:absolute; top:0%; left:0%; height:100%; width:30%; z-index:1">
    <form action="#" acceptCharset="UTF-8" onsubmit="alert(&nbsp;foo&nbsp;);">
      <input type="text" id="select_mindate" value=""></input>
      <input type="submit" value="Fetch data" onclick="refreshData()"></input>
    </form>  
    <div id="status_line" class="status_line">Ready</div>
    <div id="textual_results" class="textual_results"><br/>(no entries)</div>
  </div>
  <div id="map" class="smallmap" style="position:absolute; top:0%; left:30%; height:100%; width:70%; z-index:1"></div>

</body>
</html>


