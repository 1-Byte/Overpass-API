#!/usr/bin/env bash

# Copyright 2008, 2009, 2010, 2011, 2012 Roland Olbricht
#
# This file is part of PT_Diagrams.
#
# PT_Diagrams is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# PT_Diagrams is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with PT_Diagrams.  If not, see <http://www.gnu.org/licenses/>.

BUF="$QUERY_STRING&"

ID=0
BBOX=
INFO=
EXECBASE="`dirname $0`/../"

IFS=$'&'
for KEY_VAL in $QUERY_STRING; do
{
  if [[ ${KEY_VAL:0:3} == "id=" ]]; then
    ID="${KEY_VAL:3}"
  elif [[ ${KEY_VAL:0:5} == "bbox=" ]]; then
    BBOX=`echo "${KEY_VAL:5}" | $EXECBASE/bin/uncgi`
  elif [[ ${KEY_VAL:0:7} == "info=no" ]]; then
    INFO="--noinfo"
  fi
}; done
unset IFS

echo "Content-Type: application/osm3s+xml"
echo "Content-Encoding: gzip"
echo 'Access-Control-Allow-Origin: *'
echo

while [[ -a /tmp/augmented_diff ]]; do
{
  PID=`cat /tmp/augmented_diff`
  if [[ -a /proc/$PID ]]; then
    sleep 1
  else
    rm -f /tmp/augmented_diff
  fi
}; done
echo $$ >/tmp/augmented_diff

printf -v TDIGIT3 %03u $(($ID % 1000))
ARG=$(($ID / 1000))
printf -v TDIGIT2 %03u $(($ARG % 1000))
ARG=$(($ARG / 1000))
printf -v TDIGIT1 %03u $ARG

if [[ -z $BBOX ]]; then
{
  if [[ -z $INFO ]]; then
    cat /var/www/augmented_diffs/$TDIGIT1/$TDIGIT2/$TDIGIT3.osc.gz
  else
  {
    gunzip </var/www/augmented_diffs/$TDIGIT1/$TDIGIT2/$TDIGIT3.osc.gz | $EXECBASE/bin/process_augmented_diffs $INFO | gzip
  }; fi
};
else
{
  gunzip </var/www/augmented_diffs/$TDIGIT1/$TDIGIT2/$TDIGIT3.osc.gz | $EXECBASE/bin/process_augmented_diffs --bbox=$BBOX $INFO | gzip
}; fi

rm -f /tmp/augmented_diff
