#!/bin/bash

BUF=$QUERY_STRING\&

SKETCH_PARAMS=
BRIM_PARAMS=
BIN_DIR=../bin

while [[ -n $BUF ]]; do
{
  KEY=`echo $BUF | awk '{ print substr($0,0,match($0,"=")); }'`
  BUF=`echo $BUF | awk '{ print substr($0,match($0,"=")+1); }'`
  VALUE=`echo $BUF | awk '{ print substr($0,0,match($0,"\&")); }'`
  BUF=`echo $BUF | awk '{ print substr($0,match($0,"\&")+1); }'`
  if [[ $KEY == "network" && -n $VALUE ]]; then
  {
    NETWORK=$VALUE
    NETWORK_=`echo $VALUE | $BIN_DIR/uncgi`
  };
  elif [[ $KEY == "ref" && -n $VALUE ]]; then
  {
    REF=$VALUE
    REF_=`echo $VALUE | $BIN_DIR/uncgi`
  };
  elif [[ $KEY == "width" && -n $VALUE ]]; then
    SKETCH_PARAMS="$SKETCH_PARAMS --width=$VALUE"
  elif [[ $KEY == "height" && -n $VALUE ]]; then
    SKETCH_PARAMS="$SKETCH_PARAMS --height=$VALUE"
  elif [[ $KEY == "font-size" && -n $VALUE ]]; then
    SKETCH_PARAMS="$SKETCH_PARAMS --stop-font-size=$VALUE"
  elif [[ $KEY == "force-rows" && -n $VALUE ]]; then
    SKETCH_PARAMS="$SKETCH_PARAMS --rows=$VALUE"
  elif [[ $KEY == "style" && -n $VALUE ]]; then
  {
    SKETCH_PARAMS="$SKETCH_PARAMS --options=/opt/osm_why_api/options/sketch-line.$VALUE"
    BRIM_PARAMS="$BRIM_PARAMS --options=/opt/osm_why_api/options/sketch-line.$VALUE"
  };
  elif [[ $KEY == "correspondences" && -n $VALUE ]]; then
  {
    SKETCH_PARAMS="$SKETCH_PARAMS --walk-limit=$VALUE"
    BRIM_PARAMS="$BRIM_PARAMS --size=$VALUE"
  };
  elif [[ $KEY == "max-cors-per-line" && -n $VALUE ]]; then
    SKETCH_PARAMS="$SKETCH_PARAMS --max-correspondences-per-line=$VALUE"
  elif [[ $KEY == "max-cors-below" && -n $VALUE ]]; then
    SKETCH_PARAMS="$SKETCH_PARAMS --max-correspondences-below=$VALUE"
  elif [[ $KEY == "debug" && -n $VALUE ]]; then
    DEBUG=$VALUE
  fi
};
done

BASEDIR=`mktemp -d`

if [[ -z $REF ]]; then
{                     
  echo "Content-Type: text/plain; charset=utf-8"
  echo                                          
  echo "An empty value for ref is not allowed"  

  exit 0
};    
fi      

if [[ $DEBUG == "yes" ]]; then
{
  echo "Content-Type: text/plain; charset=utf-8"
  echo
  echo $BIN_DIR/bbox_brim_query --network="$NETWORK_" --ref="$REF_" $BRIM_PARAMS ">"$BASEDIR/request.1
  echo
};
fi

$BIN_DIR/bbox_brim_query --network="$NETWORK_" --ref="$REF_" $BRIM_PARAMS >$BASEDIR/request.1

REQUEST_METHOD=

if [[ $DEBUG == "yes" ]]; then
{
  cat <$BASEDIR/request.1
  echo
  echo $BIN_DIR/osm3s_query --verbose "<"$BASEDIR/request.1 ">"$BASEDIR/answer.1
  echo
  $BIN_DIR/osm3s_query --verbose <$BASEDIR/request.1 >$BASEDIR/answer.1 2>$BASEDIR/log.1
  echo
  cat <$BASEDIR/log.1
  cat <$BASEDIR/answer.1
  echo $BIN_DIR/sketch_route_svg --network="$NETWORK_" --ref="$REF_" $SKETCH_PARAMS <$BASEDIR/answer.1
  echo
};
else
  $BIN_DIR/osm3s_query --quiet <$BASEDIR/request.1 >$BASEDIR/answer.1
fi;

echo "Content-Type: image/svg+xml; charset=utf-8"
echo

$BIN_DIR/sketch_route_svg --network="$NETWORK_" --ref="$REF_" $SKETCH_PARAMS <$BASEDIR/answer.1
